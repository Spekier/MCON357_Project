<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Calendar with Multiple Events</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter&display=swap">
    <style>
        * {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: #f9f9f9;
            color: #333;
            padding: 20px; /* Apply padding to body, not just specific elements if navbar is full width */
        }

        nav.navbar.is-primary { /* Targeting the specific navbar from your template */
            background-color: #5e72e4; /* A common primary blue */
            padding: 0; /* Reset padding if Bulma handles it */
            margin-bottom: 20px;
        }
        nav.navbar.is-primary .container {
            max-width: 960px; /* Or your preferred container width */
            margin: 0 auto;
            display: flex;
            justify-content: space-between; /* For brand and menu */
        }
        nav.navbar.is-primary .navbar-menu {
            display: flex; /* Ensure menu items are in a row */
            align-items: center; /* Vertically align items */
        }
        nav.navbar.is-primary .navbar-end {
            display: flex;
            margin-left: auto; /* Push to the right */
        }
        nav.navbar.is-primary .navbar-item.has-text-white {
            color: white !important; /* Ensure text is white */
            text-decoration: none;
            padding: 0.5rem 0.75rem;
        }
        nav.navbar.is-primary .navbar-item.has-text-white:hover {
            background-color: rgba(0,0,0,0.1); /* Slight hover effect */
        }


        .title {
            text-align: center;
            font-size: 32px;
            margin-bottom: 20px;
        }

        .calendar-container {
            display: flex;
            justify-content: center;
        }

        .calendar {
            width: 90%;
            max-width: 800px; 
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .calendar-header h3 {
            font-size: 24px;
        }

        .calendar-header button {
            background-color: #5e72e4;
            border: none;
            color: white;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
        }

        .weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            margin-top: 20px;
            text-align: center;
            font-weight: bold;
        }

        .days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            grid-auto-rows: minmax(100px, auto); 
            gap: 5px;
            margin-top: 10px;
        }

        .days div {
            background: #f1f1f1;
            border-radius: 6px;
            padding: 5px;
            position: relative;
            overflow-y: auto;
            cursor: pointer;
            max-height: 150px; 
        }

        .day-number {
            font-weight: bold;
            margin-bottom: 3px;
        }

        .day-events {
            font-size: 12px;
            list-style: none;
            padding-left: 0;
        }

        .day-events li {
            margin-top: 5px;
            background-color: #e0e0e0; 
            padding: 2px 4px;
            border-radius: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .parsha-event {
            background-color: #d1e7dd !important; 
            color: #0f5132;
            font-weight: bold;
        }

        .holiday-event {
            background-color: #fff3cd !important; 
            color: #664d03;
            font-weight: bold;
        }

        .candlelighting-event {
            background-color: #f8d7da !important; 
            color: #58151c;
            font-size: 11px; 
        }

        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
        }

        .add-event-btn,
        .upcoming-events-btn {
            padding: 10px 20px;
            background-color: #5e72e4;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            max-width: 400px;
            width: 90%;
        }

        .modal input,
        .modal select {
            width: 100%;
            padding: 8px;
            margin: 10px 0;
            border: 1px solid #ccc;
            border-radius: 6px;
        }

        .modal-buttons {
            display: flex;
            justify-content: flex-end; 
            gap: 10px; 
            margin-top: 10px;
            flex-wrap: wrap; 
        }

        .modal-buttons button {
            padding: 8px 12px; 
            border: none;
            border-radius: 6px;
            cursor: pointer;
            background-color: #6c757d; 
            color: white;
        }
        .modal-buttons button.cancel { 
             background-color: #ccc;
             color: #333;
        }
        /* Adjust specific cancel button to align right if it's not the last one due to dynamic edit button */
        #event-view-modal .modal-buttons button.cancel {
        }
         #upcoming-events-modal .modal-buttons button.cancel {
            margin-left: auto; /* Push close to the far right in this specific modal */
        }


        .modal-buttons .save {
            background-color: #5e72e4;
            color: white;
        }
        .modal-buttons .delete {
            background-color: #dc3545;
            color: white;
        }

        .upcoming-events-list {
            max-height: 250px; 
            overflow-y: auto;
            margin: 10px 0;
        }

        .upcoming-event-item {
            background-color: #f1f1f1;
            margin: 5px 0;
            padding: 8px;
            border-radius: 6px;
        }

        .upcoming-parsha-item {
            border-left: 3px solid #198754; 
            padding-left: 5px;
        }
        .upcoming-holiday-item {
            border-left: 3px solid #ffc107; 
            padding-left: 5px;
        }
        .upcoming-candlelighting-item {
            border-left: 3px solid #dc3545; 
            padding-left: 5px;
        }


        .date-picker-container {
            position: relative;
        }

        .date-picker-container input {
            width: 100%;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/isoWeek.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/utc.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/timezone.js"></script>

</head>
<body>

    <nav class="navbar is-primary" role="navigation">
    <div class="container">
        <div class="navbar-menu is-active">
            <div class="navbar-end">
                <a href="{{ url_for('main.index') }}" class="navbar-item has-text-white">Home</a>
                {% if current_user.is_authenticated %}
                    <a href="{{ url_for('main.profile') }}" class="navbar-item has-text-white">Calendar</a>
                    <a href="{{ url_for('auth.logout') }}" class="navbar-item has-text-white">Logout</a>
                {% else %}
                    <a href="{{ url_for('auth.login') }}" class="navbar-item has-text-white">Login</a>
                    <a href="{{ url_for('auth.signup') }}" class="navbar-item has-text-white">Sign Up</a>
                {% endif %}
            </div>
        </div>
    </div>
</nav>

    
    <div class="title">{{ name }}'s Calendar</div> 
    <div class="calendar-container">
        <div class="calendar">
            <div class="calendar-header">
                <button id="prev-month">←</button>
                <h3 id="month-year"></h3>
                <button id="next-month">→</button>
            </div>
            <div class="weekdays">
                <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
            </div>
            <div class="days" id="calendar-days"></div>
        </div>
    </div>

    <div class="action-buttons">
        <button class="add-event-btn" onclick="openAddEventModal()">Add Event</button>
        <button class="upcoming-events-btn" onclick="showUpcomingEvents()">Upcoming Events</button>
    </div>

    <div class="modal" id="add-event-modal">
        <h3>Add Event</h3>
        <div class="date-picker-container">
            <input type="date" id="add-event-date" />
        </div>
        <input type="text" id="add-event-title" placeholder="Event Title">
        <input type="time" id="add-event-time">
        <label><input type="checkbox" id="add-event-allday"> All-day event</label>
        <div class="modal-buttons">
            <button class="cancel" onclick="closeAddEventModal()">Cancel</button>
            <button class="save" onclick="saveEvent()">Save</button>
        </div>
    </div>

    <div class="modal" id="edit-event-modal">
        <h3>Edit Event</h3>
        <div class="date-picker-container">
            <input type="date" id="edit-event-date" />
        </div>
        <input type="text" id="edit-event-title" placeholder="Event Title">
        <input type="time" id="edit-event-time">
        <label><input type="checkbox" id="edit-event-allday"> All-day event</label>
        <div class="modal-buttons">
            <button class="cancel" onclick="closeEditEventModal()">Cancel</button>
            <button class="save" onclick="updateEvent()">Save</button>
        </div>
    </div>

    <div class="modal" id="event-view-modal">
        <h3 id="view-event-title"></h3>
        <p id="view-event-time"></p>
        <div class="modal-buttons"> <button class="cancel" onclick="closeViewModal()">Close</button>
            <button class="delete" onclick="deleteSelectedEvent()">Delete</button>
        </div>
    </div>

    <div class="modal" id="upcoming-events-modal">
        <h3>Upcoming Events</h3>
        <div class="upcoming-events-list" id="upcoming-events-list"></div>
        <div class="modal-buttons">
            <button id="toggle-parsha-candles-btn" onclick="toggleParshaAndCandlesVisibilityInList()">Hide Parsha/Candles</button>
            <button id="toggle-holidays-btn" onclick="toggleHolidaysVisibilityInList()">Hide Holidays</button>
            <button class="cancel" onclick="closeUpcomingModal()">Close</button> 
        </div>
    </div>

    <script>
        dayjs.extend(window.dayjs_plugin_isoWeek);
        dayjs.extend(window.dayjs_plugin_utc);
        dayjs.extend(window.dayjs_plugin_timezone);

        const monthYearLabel = document.getElementById('month-year');
        const daysContainer = document.getElementById('calendar-days');
        const addEventModal = document.getElementById('add-event-modal');
        const editEventModal = document.getElementById('edit-event-modal');
        const eventViewModal = document.getElementById('event-view-modal');
        const upcomingEventsModal = document.getElementById('upcoming-events-modal');
        const upcomingEventsList = document.getElementById('upcoming-events-list');

        const addEventTitleInput = document.getElementById('add-event-title');
        const addEventTimeInput = document.getElementById('add-event-time');
        const addEventAllDayCheckbox = document.getElementById('add-event-allday');
        const addEventDateInput = document.getElementById('add-event-date');

        const editEventTitleInput = document.getElementById('edit-event-title');
        const editEventTimeInput = document.getElementById('edit-event-time');
        const editEventAllDayCheckbox = document.getElementById('edit-event-allday');
        const editEventDateInput = document.getElementById('edit-event-date');

        const viewEventTitle = document.getElementById('view-event-title');
        const viewEventTime = document.getElementById('view-event-time');

        let parshaAndCandlesVisibleInList = true; 
        let holidaysVisibleInList = true;

        let currentDate = dayjs();
        const events = {}; 
        const hebcalData = {}; 
        let selectedDate = null;
        let selectedEvent = null; 
        let selectedEventType = null; 


        function formatTo12Hour(time24) {
            if (!time24) return '';
            const [hour, minute] = time24.split(':');
            const h = parseInt(hour);
            const ampm = h >= 12 ? 'PM' : 'AM';
            const hour12 = h % 12 || 12;
            return `<span class="math-inline">\{hour12\}\:</span>{minute} ${ampm}`;
        }

        async function fetchHebcalDataForYear(year) {
            const url = `https://www.hebcal.com/hebcal?v=1&cfg=json&maj=on&min=on&mod=on&nx=on&year=${year}&month=x&ss=on&mf=on&c=on&geo=geoname&geonameid=5128581&M=off&s=on`;
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    console.error("Hebcal API Error:", response.status, await response.text());
                    hebcalData[`${year}-loaded`] = true; 
                    return;
                }
                const data = await response.json();
                if (data && data.items) {
                    data.items.forEach(item => {
                        const itemDateKey = dayjs(item.date).format('YYYY-MM-DD');
                        if (!hebcalData[itemDateKey]) hebcalData[itemDateKey] = [];
                        let eventObject = null;
                        if (item.category === 'parashat') {
                            eventObject = { title: item.title, hebrew: item.hebrew, link: item.link, allday: true, eventType: 'parsha' };
                        } else if (item.category === 'holiday' || item.yomtov === true) {
                             eventObject = { title: item.title, hebrew: item.hebrew, link: item.link, memo: item.memo, allday: true, eventType: 'holiday' };
                        } else if (item.category === 'candles') {
                            eventObject = { title: item.title, link: item.link, allday: false, dateFull: item.date, eventType: 'candlelighting' };
                        }
                        if (eventObject) {
                             const exists = hebcalData[itemDateKey].some(e => e.title === eventObject.title && e.eventType === eventObject.eventType);
                             if (!exists) hebcalData[itemDateKey].push(eventObject);
                        }
                    });
                }
            } catch (error) {
                console.error("Error fetching or parsing Hebcal data:", error);
                hebcalData[`${year}-loaded`] = true; 
            }
        }

        async function renderCalendar(date) {
            monthYearLabel.textContent = date.format('MMMM YYYY');
            daysContainer.innerHTML = '';
            const year = date.year();
            if (!hebcalData[`${year}-loaded`]) {
                await fetchHebcalDataForYear(year);
                hebcalData[`${year}-loaded`] = true; 
            }
            const startOfMonth = date.startOf('month');
            const endOfMonth = date.endOf('month');
            const startDayOfWeek = startOfMonth.day(); 
            const daysInMonth = endOfMonth.date();
            for (let i = 0; i < startDayOfWeek; i++) {
                daysContainer.appendChild(document.createElement('div'));
            }
            for (let i = 1; i <= daysInMonth; i++) {
                const dayDiv = document.createElement('div');
                const currentDayObj = date.date(i);
                const dayKey = currentDayObj.format('YYYY-MM-DD');
                let dayContent = `<div class="day-number">${i}</div><ul class="day-events">`;
                if (events[dayKey]) {
                    events[dayKey].forEach((event, index) => {
                        const title = event.title || "Untitled Event";
                        dayContent += `<li onclick='viewEvent("${dayKey}", <span class="math-inline">\{index\}, "user"\); event\.stopPropagation\(\);'\></span>{title}</li>`;
                    });
                }
                if (hebcalData[dayKey]) {
                    hebcalData[dayKey].sort((a,b) => {
                        if (a.allday && !b.allday) return -1;
                        if (!a.allday && b.allday) return 1;
                        if (a.eventType === 'candlelighting' && b.eventType !== 'candlelighting') return 1;
                        if (a.eventType !== 'candlelighting' && b.eventType === 'candlelighting') return -1;
                        return (a.title || "").localeCompare(b.title || "");
                    }).forEach((event, index) => {
                        let eventClass = '';
                        let displayTitle = event.title || "Hebcal Event";
                        let shouldRender = false;
                        if (event.eventType === 'parsha') {
                            if (currentDayObj.day() === 6) { 
                                eventClass = 'parsha-event'; shouldRender = true;
                            }
                        } else if (event.eventType === 'holiday') {
                            eventClass = 'holiday-event'; shouldRender = true;
                        } else if (event.eventType === 'candlelighting') {
                            eventClass = 'candlelighting-event'; shouldRender = true;
                        }
                        if (shouldRender) {
                            dayContent += `<li class="<span class="math-inline">\{eventClass\}" onclick\='viewEvent\("</span>{dayKey}", <span class="math-inline">\{index\}, "</span>{event.eventType}"); event.stopPropagation();'>${displayTitle}</li>`;
                        }
                    });
                }
                dayContent += `</ul>`;
                dayDiv.innerHTML = dayContent;
                dayDiv.onclick = () => openAddEventModal(dayKey);
                daysContainer.appendChild(dayDiv);
            }
        }

        function toggleParshaAndCandlesVisibilityInList() {
            parshaAndCandlesVisibleInList = !parshaAndCandlesVisibleInList; 
            const itemsToToggle = upcomingEventsList.querySelectorAll('.upcoming-parsha-item, .upcoming-candlelighting-item');
            const toggleBtn = document.getElementById('toggle-parsha-candles-btn');
            itemsToToggle.forEach(item => {
                item.style.display = parshaAndCandlesVisibleInList ? '' : 'none';
            });
            if (toggleBtn) {
                toggleBtn.textContent = parshaAndCandlesVisibleInList ? 'Hide Parsha/Candles' : 'Show Parsha/Candles';
            }
        }

        function toggleHolidaysVisibilityInList() {
            holidaysVisibleInList = !holidaysVisibleInList; 
            const holidayItems = upcomingEventsList.querySelectorAll('.upcoming-holiday-item');
            const toggleBtn = document.getElementById('toggle-holidays-btn');
            holidayItems.forEach(item => {
                item.style.display = holidaysVisibleInList ? '' : 'none';
            });
            if (toggleBtn) {
                toggleBtn.textContent = holidaysVisibleInList ? 'Hide Holidays' : 'Show Holidays';
            }
        }

        function openAddEventModal(dateStr = currentDate.format('YYYY-MM-DD')) {
            selectedDate = dateStr; 
            addEventDateInput.value = selectedDate;
            addEventTitleInput.value = '';
            addEventTimeInput.value = '';
            addEventAllDayCheckbox.checked = false;
            addEventModal.style.display = 'block';
        }

        function closeAddEventModal() { addEventModal.style.display = 'none'; }
        
        function openEditEventModalFromView() {
            if (!selectedEvent || selectedEventType === 'parsha' || selectedEventType === 'holiday' || selectedEventType === 'candlelighting') {
                alert("This type of event cannot be edited."); return;
            }
            closeViewModal(); 
            editEventDateInput.value = selectedDate; 
            editEventTitleInput.value = selectedEvent.title;
            editEventTimeInput.value = selectedEvent.allday ? '' : selectedEvent.time || '';
            editEventAllDayCheckbox.checked = selectedEvent.allday || false;
            editEventModal.style.display = 'block';
        }

        function closeEditEventModal() { editEventModal.style.display = 'none'; }

        function viewEvent(dateKey, index, eventType) {
            selectedDate = dateKey; selectedEventType = eventType; 
            const isHebcalEvent = (eventType === 'parsha' || eventType === 'holiday' || eventType === 'candlelighting');
            const eventSource = isHebcalEvent ? hebcalData : events;
            if (!eventSource[dateKey] || !eventSource[dateKey][index]) {
                console.warn("Event not found for view:", dateKey, index, eventType); return;
            }
            selectedEvent = eventSource[dateKey][index];
            viewEventTitle.textContent = selectedEvent.title || "Event Details"; 
            let timeText = '';
            if (selectedEvent.allday) {
                timeText = 'All day';
                if ((eventType === 'parsha' || eventType === 'holiday') && selectedEvent.hebrew) timeText += ` (${selectedEvent.hebrew})`;
            } else if (eventType === 'candlelighting' && selectedEvent.dateFull) {
                 timeText = dayjs(selectedEvent.dateFull).format('h:mm A');
                 if (selectedEvent.hebrew) timeText += ` (${selectedEvent.hebrew})`;
            } else if (selectedEvent.time) { 
                timeText = formatTo12Hour(selectedEvent.time);
            }
            viewEventTime.textContent = timeText;
            const modalButtonsContainer = eventViewModal.querySelector(".modal-buttons");
            const deleteButton = modalButtonsContainer.querySelector("button.delete");
            let editButton = modalButtonsContainer.querySelector("button.edit-dynamic");
            if (editButton) editButton.remove(); 
            if (!isHebcalEvent) { 
                editButton = document.createElement('button');
                editButton.textContent = "Edit"; editButton.className = "edit-dynamic"; 
                editButton.style.backgroundColor = '#5e72e4'; // Match save button style
                editButton.style.color = 'white';
                editButton.onclick = openEditEventModalFromView;
                modalButtonsContainer.insertBefore(editButton, deleteButton);
            }
            if (isHebcalEvent) {
                if(deleteButton) deleteButton.style.display = 'none';
                if (selectedEvent.link) viewEventTitle.innerHTML = `<a href="<span class="math-inline">\{selectedEvent\.link\}" target\="\_blank" rel\="noopener noreferrer"\></span>{selectedEvent.title}</a>`;
            } else { 
                if(deleteButton) deleteButton.style.display = 'inline-block';
            }
            eventViewModal.style.display = 'block';
        }

        function closeViewModal() {
            eventViewModal.style.display = 'none'; selectedEvent = null; selectedEventType = null;
        }

        function deleteSelectedEvent() {
            if (!selectedEvent || selectedEventType === 'parsha' || selectedEventType === 'holiday' || selectedEventType === 'candlelighting') {
                 alert("This type of event cannot be deleted."); return;
            }
            if (!events[selectedDate]) return;
            const eventIndex = events[selectedDate].findIndex(event => event.title === selectedEvent.title && event.time === selectedEvent.time);
            if (eventIndex > -1) {
                events[selectedDate].splice(eventIndex, 1);
                if (events[selectedDate].length === 0) delete events[selectedDate];
            }
            closeViewModal(); renderCalendar(currentDate);
        }

        function saveEvent() {
            const title = addEventTitleInput.value.trim();
            const time = addEventTimeInput.value;
            const allday = addEventAllDayCheckbox.checked;
            const date = addEventDateInput.value; 
            if (!title || (!allday && !time) || !date) {
                alert("Please provide a title and either a time or mark as all-day."); return;
            }
            if (!events[date]) events[date] = [];
            events[date].push({ title, time: allday ? '' : time, allday, eventType: 'user' });
            closeAddEventModal(); renderCalendar(currentDate);
        }

        function updateEvent() {
            const title = editEventTitleInput.value.trim();
            const time = editEventTimeInput.value;
            const allday = editEventAllDayCheckbox.checked;
            const newDate = editEventDateInput.value; 
            if (!title || (!allday && !time) || !newDate) {
                alert("Please provide a title, date, and either a time or mark as all-day."); return;
            }
            if (!selectedEvent || !events[selectedDate] || selectedEventType !== 'user') return;
            const eventIndex = events[selectedDate].findIndex(event => event.title === selectedEvent.title && event.time === selectedEvent.time);
            if (eventIndex === -1) { console.error("Original event not found for update."); return; }
            events[selectedDate].splice(eventIndex, 1);
            if (events[selectedDate].length === 0) delete events[selectedDate];
            if (!events[newDate]) events[newDate] = [];
            events[newDate].push({ title, time: allday ? '' : time, allday, eventType: 'user' });
            closeEditEventModal(); renderCalendar(currentDate);
        }

        function showUpcomingEvents() {
            const now = dayjs();
            let futureEvents = []; 
            for (const dateKey in events) {
                const eventDateObj = dayjs(dateKey);
                 events[dateKey].forEach(e => {
                    if (e.allday) { 
                        if (eventDateObj.isAfter(now, 'day') || eventDateObj.isSame(now, 'day')) {
                             futureEvents.push({ date: dateKey, ...e });
                        }
                    } else if (e.time) { 
                        const specificEventMoment = dayjs(`<span class="math-inline">\{dateKey\}T</span>{e.time}`);
                        if (specificEventMoment.isAfter(now)) {
                            futureEvents.push({ date: dateKey, ...e });
                        }
                    }
                });
            }
            for (const dateKey in hebcalData) {
                if (dateKey.endsWith('-loaded')) continue; 
                hebcalData[dateKey].forEach(e => {
                    const eventMoment = dayjs(e.eventType === 'candlelighting' ? e.dateFull : dateKey);
                    let includeEvent = false;
                    if (e.eventType === 'candlelighting') {
                        if (eventMoment.isAfter(now)) includeEvent = true;
                    } else if (e.eventType === 'parsha') {
                        if (eventMoment.day() === 6 && (eventMoment.isAfter(now, 'day') || eventMoment.isSame(now, 'day'))) {
                           includeEvent = true;
                        }
                    } else if (e.eventType === 'holiday') {
                        if (eventMoment.isAfter(now, 'day') || eventMoment.isSame(now, 'day')) {
                            includeEvent = true;
                        }
                    }
                    if (includeEvent) {
                         futureEvents.push({ 
                            date: eventMoment.format('YYYY-MM-DD'), 
                            timeSpecific: e.eventType === 'candlelighting' ? eventMoment.format('h:mm A') : null, ...e 
                        });
                    }
                });
            }
            futureEvents.sort((a, b) => {
                let dateA, dateB;
                if (a.eventType === 'candlelighting') dateA = dayjs(a.dateFull);
                else if (a.eventType === 'user' && !a.allday && a.time) dateA = dayjs(`<span class="math-inline">\{a\.date\}T</span>{a.time}`);
                else dateA = dayjs(a.date).startOf('day');
                if (b.eventType === 'candlelighting') dateB = dayjs(b.dateFull);
                else if (b.eventType === 'user' && !b.allday && b.time) dateB = dayjs(`<span class="math-inline">\{b\.date\}T</span>{b.time}`);
                else dateB = dayjs(b.date).startOf('day');
                return dateA.unix() - dateB.unix();
            });
            upcomingEventsList.innerHTML = futureEvents.map(e => {
                const eventDateObj = dayjs(e.eventType === 'candlelighting' ? e.dateFull : e.date);
                const dayOfWeek = eventDateObj.format('dddd');
                let details = e.title || "Event";
                let itemClass = '';
                if (e.eventType === 'parsha') {
                    itemClass = 'upcoming-parsha-item'; if (e.hebrew) details += ` (${e.hebrew})`;
                } else if (e.eventType === 'holiday') {
                    itemClass = 'upcoming-holiday-item'; if (e.hebrew) details += ` (${e.hebrew})`;
                    if (e.allday) details += ' (All day)';
                } else if (e.eventType === 'candlelighting') {
                    itemClass = 'upcoming-candlelighting-item';
                } else { 
                     if (e.allday) { details += ' (All day)'; } 
                     else if (e.time) { details += ` at ${formatTo12Hour(e.time)}`; }
                }
                return `<div class="upcoming-event-item <span class="math-inline">\{itemClass\}"\>
<strong\></span>{dayOfWeek}, ${eventDateObj.format('MMMM D, YYYY')}</strong>: ${details}
                            ${(e.eventType !== 'user' && e.link) ? ` <a href="${e.link}" target="_blank" rel="noopener noreferrer">(Details)</a>` : ''}
                        </div>`;
            }).join('');
            
            parshaAndCandlesVisibleInList = true; 
            holidaysVisibleInList = true; 
            const toggleParshaCandlesBtn = document.getElementById('toggle-parsha-candles-btn');
            if (toggleParshaCandlesBtn) toggleParshaCandlesBtn.textContent = 'Hide Parsha/Candles';
            const toggleHolidaysBtn = document.getElementById('toggle-holidays-btn');
            if (toggleHolidaysBtn) toggleHolidaysBtn.textContent = 'Hide Holidays';
            upcomingEventsList.querySelectorAll('.upcoming-parsha-item, .upcoming-candlelighting-item').forEach(item => {
                item.style.display = ''; 
            });
            upcomingEventsList.querySelectorAll('.upcoming-holiday-item').forEach(item => {
                item.style.display = ''; 
            });
            upcomingEventsModal.style.display = 'block';
        }

        function closeUpcomingModal() { upcomingEventsModal.style.display = 'none'; }

        document.getElementById('prev-month').onclick = () => {
            currentDate = currentDate.subtract(1, 'month'); renderCalendar(currentDate);
        };
        document.getElementById('next-month').onclick = () => {
            currentDate = currentDate.add(1, 'month'); renderCalendar(currentDate);
        };
        renderCalendar(currentDate);
    </script>
</body>
</html>

